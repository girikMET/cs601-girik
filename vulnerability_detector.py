import subprocess
import argparse
import json
from datetime import timedelta

def trivy_vs_osquery(passed_image):
    with open("trivy_scan_results.json", "w+") as trivy_scan_out:
        subprocess.Popen('trivy i -f json ' + passed_image + ' 2>/dev/null', stdout=trivy_scan_out, stderr=None, shell=True).wait()
        subprocess.Popen('jq .Results trivy_scan_results.json > trivy_results.json', stdout=None, stderr=None, shell=True).wait()
    fd = open("vulnerabilities.csv", 'w+')
    fd.write("VulnerabilityID,Severity,PkgName,PkgPath,InstalledVersion,FixedVersion,PublishedDate,LastModifiedDate\n")
    with open("trivy_results.json") as trivy_csv_fd:
        json_object = json.load(trivy_csv_fd)
        if json_object != None:
            for vulobject in json_object:
                if 'Vulnerabilities' in vulobject:
                    for typevulobject in vulobject['Vulnerabilities']:
                        output = "{},{},{},{},{},{},{},{}".format(typevulobject.get('VulnerabilityID', ''), typevulobject.get('Severity', ''), typevulobject.get('PkgName', ''), typevulobject.get('PkgPath', ''), typevulobject.get('InstalledVersion', ''), typevulobject.get('FixedVersion', ''), typevulobject.get('PublishedDate', ''), typevulobject.get('LastModifiedDate', ''))
                        fd.write(output + "\n")
    fd.close()
    subprocess.Popen('rm -rf ./*.json', stdout=None, stderr=None, shell=True).wait()

def main():
    parser = argparse.ArgumentParser(description='Parse the Arguments Parameters')
    parser.add_argument('--image', default='ubuntu', required=False)
    args = parser.parse_args()
    trivy_vs_osquery(args.image)

if __name__ == '__main__':
    main()
